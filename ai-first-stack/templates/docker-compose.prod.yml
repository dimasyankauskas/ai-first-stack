version: "3.8"

services:
  pocketbase:
    build:
      context: .
      dockerfile: Dockerfile.pocketbase
    restart: always
    ports:
      - 8090
    volumes:
      - pocketbase-data:/pb/pb_data
    environment:
      - ADMIN_EMAIL=${ADMIN_EMAIL}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - PB_ENCRYPTION_KEY=${PB_ENCRYPTION_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8090/api/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
    networks:
      - dokploy-network
    labels:
      # ⚠️ CHANGE THESE TO YOUR PROJECT + DOMAIN
      - "traefik.enable=true"
      - "traefik.http.routers.YOUR_PROJECT-pocketbase.rule=Host(`api.yourdomain.com`)"
      - "traefik.http.routers.YOUR_PROJECT-pocketbase.entrypoints=websecure"
      - "traefik.http.routers.YOUR_PROJECT-pocketbase.tls.certResolver=letsencrypt"
      - "traefik.http.services.YOUR_PROJECT-pocketbase.loadbalancer.server.port=8090"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # ✅ CRITICAL: NEXT_PUBLIC_POCKETBASE_URL is baked into the Next.js bundle at BUILD TIME
        # Setting it here ensures the URL is compiled into the frontend.
        # Changing this requires a **rebuild/redeploy** of the frontend service.
        NEXT_PUBLIC_POCKETBASE_URL: ${NEXT_PUBLIC_POCKETBASE_URL}
    restart: always
    ports:
      - 3000
    environment:
      # ℹ️ Runtime environment variables ONLY
      # Note: NEXT_PUBLIC_POCKETBASE_URL is NOT included here because it's already baked in via build arg.
      # If you change NEXT_PUBLIC_POCKETBASE_URL in your env file and redeploy, Dokploy will rebuild
      # the frontend with the new value. Do NOT add NEXT_PUBLIC_* vars to this section.
      - NODE_ENV=production
    depends_on:
      pocketbase:
        condition: service_healthy
    networks:
      - dokploy-network
    labels:
      # ⚠️ CHANGE THESE TO YOUR PROJECT + DOMAIN
      - "traefik.enable=true"
      - "traefik.http.routers.YOUR_PROJECT-frontend.rule=Host(`app.yourdomain.com`)"
      - "traefik.http.routers.YOUR_PROJECT-frontend.entrypoints=websecure"
      - "traefik.http.routers.YOUR_PROJECT-frontend.tls.certResolver=letsencrypt"
      - "traefik.http.services.YOUR_PROJECT-frontend.loadbalancer.server.port=3000"

volumes:
  pocketbase-data:


networks:
  dokploy-network:
    # ⚠️ IMPORTANT: This network must exist before deploying.
    # Dokploy automatically creates dokploy-network on first project creation.
    # If deploying manually or getting "network not found" error:
    # Run: docker network create dokploy-network
    external: true
